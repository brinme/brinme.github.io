<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Email - Brinme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="js/telegram-integration.js"></script>
    <style>
        body { font-family: 'Montserrat', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 text-center">
        <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-[#25A8D9]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
        </div>
        
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Verify your email</h1>
        <p class="text-gray-500 mb-8">
            We sent a verification link to <br>
            <span id="userEmail" class="font-medium text-gray-900">your email</span>
        </p>

        <div class="space-y-3">
            <button id="checkBtn" class="w-full py-3.5 px-4 bg-[#25A8D9] hover:bg-[#1e90c7] text-white font-bold rounded-xl transition-colors shadow-lg shadow-blue-100">
                I've verified my email
            </button>
            
            <button id="resendBtn" class="w-full py-3.5 px-4 bg-white border border-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition-colors">
                Resend Email
            </button>
        </div>

        <p id="message" class="mt-4 text-sm text-center hidden"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, sendEmailVerification, reload } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { firebaseConfig } from './js/firebase-config.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        const userEmailSpan = document.getElementById('userEmail');
        const checkBtn = document.getElementById('checkBtn');
        const resendBtn = document.getElementById('resendBtn');
        const messageEl = document.getElementById('message');

        function showMessage(text, isError = false) {
            messageEl.textContent = text;
            messageEl.className = `mt-4 text-sm text-center ${isError ? 'text-red-500' : 'text-green-500'}`;
            messageEl.classList.remove('hidden');
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userEmailSpan.textContent = user.email;
                
                // If already verified, go to home
                if (user.emailVerified) {
                    window.location.href = 'index.html';
                }
            } else {
                // Not logged in
                if (window.isTelegramApp) {
                    window.location.href = 'index.html'; // Will trigger auto-login
                } else {
                    window.location.href = 'login.html';
                }
            }
        });

        checkBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                checkBtn.disabled = true;
                checkBtn.textContent = "Checking...";
                
                try {
                    await reload(user);
                    if (user.emailVerified) {
                        window.location.href = 'index.html';
                    } else {
                        showMessage("Email not verified yet. Please check your inbox.", true);
                        checkBtn.disabled = false;
                        checkBtn.textContent = "I've verified my email";
                    }
                } catch (error) {
                    console.error(error);
                    showMessage("Error checking status.", true);
                    checkBtn.disabled = false;
                    checkBtn.textContent = "I've verified my email";
                }
            }
        });

        resendBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                resendBtn.disabled = true;
                try {
                    await sendEmailVerification(user);
                    showMessage("Verification email sent!");
                    
                    // Cooldown
                    let count = 60;
                    const interval = setInterval(() => {
                        resendBtn.textContent = `Resend in ${count}s`;
                        count--;
                        if (count < 0) {
                            clearInterval(interval);
                            resendBtn.disabled = false;
                            resendBtn.textContent = "Resend Email";
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error(error);
                    showMessage("Error sending email: " + error.message, true);
                    resendBtn.disabled = false;
                }
            }
        });
    </script>
</body>
</html>